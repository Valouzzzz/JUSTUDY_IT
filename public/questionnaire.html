<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Questionnaire</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }

        .category-selector {
            margin-bottom: 20px;
        }

        button {
            padding: 10px 15px;
            margin: 5px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
        }

        button:hover {
            background-color: #45a049;
        }

        #flashcard-container {
            display: none;
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }

        #question {
            font-size: 18px;
            margin-bottom: 10px;
        }

        #answer {
            display: none;
            font-size: 16px;
            margin: 10px 0;
            font-weight: bold;
        }

        #user-response-buttons {
            margin-top: 10px;
        }

        #result {
            display: none;
            margin-top: 20px;
            font-size: 20px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Questionnaire</h1>

    <div class="category-selector">
        <button id="all-categories">Toutes les catégories</button>
        <div id="category-buttons"></div>
    </div>

    <div id="flashcard-container">
        <div id="question"></div>
        <button id="show-answer">Afficher la réponse</button>
        <div id="answer"></div>
        <div id="user-response-buttons">
            <button id="correct">Bonne réponse</button>
            <button id="incorrect">Mauvaise réponse</button>
        </div>
    </div>

    <div id="result"></div>

    <button onclick="window.location.href='http://localhost:3000/flashcarde.html'">Retour</button>
    <script>
        // Charger les flashcards depuis le fichier JSON
        let flashcards = [];
        fetch('../flashcards.json')
            .then(response => response.json())
            .then(data => {
                flashcards = data;
                displayCategoryButtons();
            })
            .catch(error => console.error('Erreur lors du chargement des flashcards:', error));

        // Afficher les boutons de catégorie
        function displayCategoryButtons() {
            const categories = [...new Set(flashcards.map(card => card.category))];
            const categoryButtonsContainer = document.getElementById('category-buttons');

            categories.forEach(category => {
                const button = document.createElement('button');
                button.textContent = category;
                button.onclick = () => startSession(category);
                categoryButtonsContainer.appendChild(button);
            });
        }

        // Démarrer une session
        function startSession(category = null) {
            let filteredFlashcards = category
                ? flashcards.filter(card => card.category === category)
                : [...flashcards];

            // Mélanger les flashcards
            filteredFlashcards = shuffleArray([...filteredFlashcards]);

            document.getElementById('flashcard-container').style.display = 'block';
            document.getElementById('result').style.display = 'none';

            let currentIndex = 0;
            let correctAnswers = 0;

            // Afficher la première flashcard
            displayFlashcard(filteredFlashcards[currentIndex]);

            // Gérer l'affichage de la réponse
            document.getElementById('show-answer').onclick = () => {
                document.getElementById('answer').style.display = 'block';
                document.getElementById('answer').textContent = filteredFlashcards[currentIndex].answer;
            };

            // Gérer la réponse correcte
            document.getElementById('correct').onclick = () => {
                document.getElementById('answer').style.display = 'none';
                correctAnswers++;
                moveToNextFlashcard(filteredFlashcards, currentIndex, correctAnswers);
            };

            // Gérer la réponse incorrecte
            document.getElementById('incorrect').onclick = () => {
                document.getElementById('answer').style.display = 'none';
                moveToNextFlashcard(filteredFlashcards, currentIndex, correctAnswers);
            };

            // Fonction pour passer à la flashcard suivante
            function moveToNextFlashcard(flashcards, index, correctCount) {
                index++;
                if (index < flashcards.length) {
                    currentIndex = index;
                    displayFlashcard(flashcards[currentIndex]);
                } else {
                    const percentage = (correctCount / flashcards.length) * 100;
                    document.getElementById('result').textContent =
                        `Session terminée ! Votre score : ${correctCount}/${flashcards.length} (${percentage.toFixed(2)}%)`;
                    document.getElementById('result').style.display = 'block';
                    document.getElementById('flashcard-container').style.display = 'none';
                }
            }
        }

        // Afficher une flashcard
        function displayFlashcard(flashcard) {
            document.getElementById('question').textContent = flashcard.question;
            document.getElementById('answer').textContent = '';
        }

        // Mélanger un tableau
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Bouton pour démarrer une session avec toutes les catégories
        document.getElementById('all-categories').onclick = () => startSession();

	function startSession(category = null) {
        let filteredFlashcards = category
            ? flashcards.filter(card => card.category === category)
            : [...flashcards];

        filteredFlashcards = shuffleArray([...filteredFlashcards]);

        document.getElementById('flashcard-container').style.display = 'block';
        document.getElementById('result').style.display = 'none';

        let currentIndex = 0;
        let correctAnswers = 0;

        displayFlashcard(filteredFlashcards[currentIndex]);

        document.getElementById('show-answer').onclick = () => {
            document.getElementById('answer').style.display = 'block';
            document.getElementById('answer').textContent = filteredFlashcards[currentIndex].answer;
        };

        document.getElementById('correct').onclick = () => {
            document.getElementById('answer').style.display = 'none';
            correctAnswers++;
            moveToNextFlashcard(filteredFlashcards, currentIndex, correctAnswers);
        };

        document.getElementById('incorrect').onclick = () => {
            document.getElementById('answer').style.display = 'none';
            moveToNextFlashcard(filteredFlashcards, currentIndex, correctAnswers);
        };

        function moveToNextFlashcard(flashcards, index, correctCount) {
            index++;
            if (index < flashcards.length) {
                currentIndex = index;
                displayFlashcard(flashcards[currentIndex]);
            } else {
                const percentage = (correctCount / flashcards.length) * 100;
                document.getElementById('result').textContent =
                    `Session terminée ! Votre score : ${correctCount}/${flashcards.length} (${percentage.toFixed(2)}%)`;
                document.getElementById('result').style.display = 'block';
                document.getElementById('flashcard-container').style.display = 'none';

                // Sauvegarder dans le serveur (JSON)
                saveResult(correctCount, flashcards.length, percentage);
            }
        }
    }

    // Sauvegarde des résultats dans le serveur
    function saveResult(correct, total, percent) {
        const data = {
            date: new Date().toISOString().split('T')[0], // yyyy-mm-dd
            time: new Date().toLocaleTimeString(),
            correct: correct,
            total: total,
            percentage: percent
        };

        fetch('/save-questionnaire', {   // route côté serveur
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(res => res.json())
        .then(response => {
            console.log("Résultat sauvegardé :", response);
        })
        .catch(err => console.error("Erreur sauvegarde :", err));
    }

    document.getElementById('all-categories').onclick = () => startSession();
    </script>
</body>
</html>

